---
title: pupeteeræ‰¹é‡ä¸‹è½½è¯•å·
theme: awesome-green
highlight:
---
è¿™ä¸¤å¤©æœ‹å‹é—®æˆ‘ï¼Œå¥¹æ‰‹ä¸Šæœ‰ä¸ªé‡å¤æ€§ç¹ççš„å·¥ä½œï¼Œèƒ½ä¸èƒ½å¸®å¿™æä¸ªç¨‹åºå¹²æ‰ï¼Ÿï¼
ç®€è¨€ä¹‹ï¼Œæ ¹æ®æŸ¥è¯¢æ¡ä»¶ï¼ŒæŠŠæœåˆ°ç›¸åº”ç»“æœçš„è¯•å·åˆ—è¡¨éƒ½ä¸‹è½½ä¸‹æ¥ã€‚
ä½†æ˜¯æ­¥éª¤æœ‰ç‚¹å¤šï¼š
1. ç‚¹å‡»æŸ¥è¯¢æ¡ä»¶ï¼Œæœå‡ºè¯•å·åˆ—è¡¨
2. ç‚¹å‡»ç¬¬ä¸€ä¸ªè¯•å·ï¼Œè·³åˆ°è¯•å·è¯¦æƒ…é¡µ
3. ç‚¹å‡»è¯¦æƒ…é¡µçš„**æ‰“å°è¯•å·**æŒ‰é’®
4. é¡µé¢çŠ¶æ€æ›´æ–°ï¼Œç‚¹å‡»**ç«‹å³æ‰“å°**æŒ‰é’®
5. å¼¹æ¡†æ‰“å°æ¡†ï¼Œå°†é€‰é¡¹è®¾ç½®ä¸ºâ€œå¦å­˜ä¸ºPDFâ€ï¼Œæ–‡ä»¶åæ”¹æˆè¯•å·å
6. å‹¾é€‰é¢„è§ˆé¡µçš„**ç­”æ¡ˆ**å’Œ**è§£æ**ï¼Œç‚¹å‡»é¢„è§ˆé¡µçš„**ç«‹å³æ‰“å°**æŒ‰é’®
7. å¼¹æ¡†æ‰“å°æ¡†ï¼Œå°†é€‰é¡¹è®¾ç½®ä¸ºâ€œå¦å­˜ä¸ºPDFâ€ï¼Œæ–‡ä»¶åæ”¹æˆ**è¯•å·å-ç­”æ¡ˆ**

æˆ‘ä¸€å¬æ„Ÿè§‰è¿˜è¡Œï¼Œè¿™ä¸å°±æ˜¯pupeteerçš„æ´»ä¹ˆï¼Œæˆ‘æ¥æ½ï¼

ç»“æœå†™çš„æ—¶å€™ï¼Œä¸€å †é˜»ç¢ï¼Œä½†æ˜¯æœ€åå®ç°äº†ï¼å†™ä¸‹è¿‡ç¨‹å’Œä»£ç ï¼Œä¸‡ä¸€ä¹‹åç”¨åˆ°å‘¢ï¼

## é—®é¢˜1:æ€ä¹ˆä¹Ÿæ‰¾ä¸åˆ°é¢„è§ˆé¡µçš„ç«‹å³æ‰“å°æŒ‰é’®ï¼

å¥‡æ€ªï¼Œå†™çš„æ—¶å€™ï¼Œè¯¦æƒ…é¡µçš„æ‰“å°æŒ‰é’®éƒ½èƒ½æ‰¾åˆ°ï¼Œä½†ç¬¬4æ­¥çš„**ç«‹å³æ‰“å°**æŒ‰é’®æ‰¾ä¸åˆ°ï¼Œè°ƒè¯•äº†ä¸€é˜µå­ï¼
åæ¥æ‰å‘ç°ï¼Œç«‹å³æ‰“å°å…¶å®æ˜¯åœ¨ä¸€ä¸ªiframeé‡Œï¼Œç›´æ¥çš„é€‰æ‹©å™¨æ˜¯æ‰¾ä¸åˆ°çš„ï¼Œé€šè¿‡iframeæ‰¾ã€‚
å¥½ï¼Œä¸‹æ¬¡çŸ¥é“äº†ï¼Œiframeé‡Œçš„é€‰æ‹©å™¨ï¼Œå¾—é€šè¿‡iframeæ‰è¡Œã€‚

## é—®é¢˜2ï¼šç‚¹äº†ç«‹å³æ‰“å°æŒ‰é’®ï¼Œæ²¡ååº”ï¼

å˜ï¼Ÿç‚¹äº†ä¸ºå•¥æ²¡ååº”ï¼ŒæŒ‰é’®å¥½ä¸å®¹æ˜“æ‰¾åˆ°äº†ï¼
ç¿»æ¥è¦†å»æ‰¾äº†é˜µå­ï¼Œæƒ³ç€ä¹Ÿè®¸æ˜¯å’Œæµè§ˆå™¨çš„é»˜è®¤æ‰“å°æ¡†æœ‰å…³ï¼Œç„¶åæœæœæ€ä¹ˆå¼¹æ‰“å°æ¡†

æ™ºèƒ½AIçš„å»ºè®®æ˜¯ï¼Œæ¨¡æ‹ŸæŒ‰é”®ï¼š Command+Pï¼Œä½†ä¸å¥½ä½¿ã€‚
æœ€åä½¿ç”¨çš„æ˜¯ window.print()

ä½†ç´§æ¥ç€æ›´å¤§çš„å‘æ¥äº†ï¼Œå¼¹æ¡†å‡ºç°äº†ï¼Œä½†æ˜¯æ§åˆ¶ä¸äº†ä¸Šé¢çš„é€‰é¡¹ï¼Œä¹Ÿä¸èƒ½æ§åˆ¶ç‚¹å‡»ä¿å­˜é”®ï¼ï¼

å¡äº†åŠå¤©ï¼

åæ¥åˆæƒ³äº†ï¼Œæ²¡å¿…è¦éå¾—å¼¹æ¡†ï¼Œæˆ‘çš„ç›®æ ‡æ˜¯PDFå•Šï¼Œçœ‹æœ‰æ²¡æœ‰ç”ŸæˆPDFçš„æ–¹æ³•ä¸å°±æ˜¯ï¼Œæˆ‘çœŸæ˜¯ä¸ªå¤§èªæ˜ï¼`page.pdf()`å°±æ˜¯è¿™ä¹ˆä¸ªæ–¹æ³•

ä½†æ˜¯ï¼ä¿å­˜ä¸‹æ¥çš„é¡µé¢æ²¡æœ‰å…¨ä¹ï¼Œåªæœ‰å¯è§†åŒºåŸŸï¼Œæˆ‘åˆæ¥å›è¯•äº†å¥½å‡ éï¼Œè¿™å°±è¦ä¸èƒ½æ½äº†ä¹ˆï¼æˆ‘ä¸ä¿¡ï¼æˆ‘ä¸æœå•Šï¼

æˆ‘åˆçµæœºä¸€åŠ¨ï¼ï¼

è¿™ä¸æ˜¯iframeä¹ˆï¼Œæˆ‘ç›´æ¥ç”¨æ–°é¡µé¢æ‰“å¼€è¯•è¯•ï¼

å’¦ï¼é è°±ï¼è¿™æ—¶å€™å†è°ƒç”¨`pdf`ï¼Œåˆå¤šäº†ä¸ªå¤´éƒ¨å’Œè¾¹ä¸Šçš„ä¸€ç‚¹èƒŒæ™¯ï¼

å•Šå‘€å‘€ï¼æ²¡äº‹ï¼éš¾ä¸å€’æˆ‘ï¼è®¾ç½®æ ·å¼å¹²æ‰ï¼

é è°±ï¼ç»ˆäºä¸€ä¸ªæ»¡æ„çš„pdfç”Ÿæˆäº†ï¼

å¥½ï¼Œä¸‹æ¬¡çŸ¥é“äº†ï¼Œå¸¦ç€iframeçš„é¡µé¢pdfç”Ÿæˆæœ‰é—®é¢˜ï¼Œå•ç‹¬æ‰“å¼€æ–°é¡µé¢å°±å¥½äº†ï¼éƒ¨åˆ†æ ·å¼æœ‰å‡ºå…¥çš„è¯ï¼Œè®¾ç½®ä¸‹å°±è¡Œï¼


## é—®é¢˜3ï¼šä»åˆ—è¡¨é‡ŒæŒ¨ä¸ªç‚¹ï¼Œè°ƒæ•´åˆ°è¯¦æƒ…é¡µï¼Œè¿™ä¸ªæ„Ÿè§‰å¾ˆè´¹åŠ²ï¼

åˆ—è¡¨é¡¹é•¿åº¦ä¹Ÿä¸å¤ªä¸€æ ·ï¼Œé¡µæ•°ä¹Ÿä¸å¤ªä¸€æ ·ï¼Œç›´æ¥ç”¨é€‰æ‹©å™¨æœ‰ç‚¹è´¹åŠ²å•Šï¼
å’‹æ•´ï¼Ÿ  
æœ‰äº†ï¼  
ç›´æ¥ç”¨æŸ¥è¯¢æ¡ä»¶ï¼Œè¯·æ±‚æ¥å£ï¼Œæ¥å£è¿”å›åˆ—è¡¨ä¿¡æ¯ï¼Œå†æŠŠå•ä¸ªé¡¹ä¿¡æ¯å‚æ•°è¿›è¡Œæ‹¼æ¥ï¼Œè¿™æ ·å°±èƒ½å¾—åˆ°è¯¦æƒ…åœ°å€æ•°ç»„äº†ï¼

ä¸‹æ¬¡å°±æ™“å¾—äº†ï¼æ‰¹é‡è¯¦æƒ…é¡µï¼Œå°±ç”¨åˆ—è¡¨æ•°æ®æ‹¼æ¥æˆé“¾æ¥å¥½äº†ï¼  

## é—®é¢˜3ï¼šæœ‹å‹å¯ä¸æ˜¯å¼€å‘äººå‘˜å•Šï¼Œæ€ä¹ˆè¿è¡Œä»£ç å‘¢ï¼ï¼

åŠŸèƒ½éƒ½å†™å®Œäº†ï¼Œæˆ‘ç”µè„‘è¿è¡Œæ²¡é—®é¢˜ï¼Œä½†æ˜¯å¥¹å¯èƒ½ç»å¸¸ç”¨è¿™ä¸ªåŠŸèƒ½ï¼Œå¥¹æƒ³è‡ªå·±å¹²å‘ï¼

è¿™ä¸ªå¤´ç§ƒçš„ï¼

å—¯ã€‚ã€‚ã€‚ã€‚

å†™ä¸ªå‘½ä»¤å§ï¼å‘å¸ƒåˆ°npmä¸Šï¼å›å¤´ç”µè„‘æ‰§è¡Œä¸ªå‘½ä»¤å°±è¡Œï¼ï¼

è¿˜èƒ½æŠŠæŸ¥è¯¢æ¡ä»¶ï¼Œå†™æˆå‘½ä»¤å‚æ•°ï¼è¿™æ ·æ¢æ¡ä»¶ï¼Œä¹Ÿèƒ½çµæ´»ä¸‹è½½ï¼

æˆ‘çœŸæ˜¯ä¸ªå¤§èªæ˜ï¼

ä¸‹æ¬¡å°±çŸ¥é“äº†ï¼è®©éå¼€å‘äººå‘˜å¿«é€Ÿä½¿ç”¨åŠŸèƒ½ï¼Œå°±å†™æˆå‘½ä»¤å‘å¸ƒï¼Œè¿™æ ·å°±èƒ½ç”¨äº†ï¼

## é—®é¢˜4ï¼šwindowsçš„è·¯å¾„åˆ†éš”ç¬¦ä¸æ”¯æŒï¼

å‘½ä»¤å†™å®Œäº†ï¼
npmåŒ…éƒ½å‘å®Œäº†ï¼
æˆ‘è¯•äº†ä¸‹windowsæ‰§è¡Œï¼Œé ï¼Œè·¯å¾„æŠ¥é”™äº†ï¼
å› ä¸ºæˆ‘çš„æ˜¯mac!
è¿™ä¸ªé—®é¢˜è¿˜ç®—å°é—®é¢˜ï¼Œå’”å’”å’”ï¼Œä¸€é¡¿æ”¹ï¼Œå°†è·¯å¾„åˆ†éš”ç¬¦æ”¹æˆåŠ¨æ€è·å–ï¼

ä¸‹æ¬¡çŸ¥é“äº†ï¼macå’Œwindowsçš„è·¯å¾„åˆ†éš”ç¬¦ä¸ä¸€æ ·ï¼Œå†™é€šç”¨å‘½ä»¤ï¼Œå¾—å†™æ´»çš„ï¼

## é—®é¢˜5ï¼šChromeçš„è·¯å¾„ä¸æ”¯æŒï¼

å†æ¬¡å‘åŒ…ï¼  
å†æ¬¡windowsæ‰§è¡Œï¼  
é ï¼å¤±è´¥äº†ï¼  
æ‰¾ä¸åˆ°Chromeï¼Œæ‰“ä¸å¼€ï¼  
å› ä¸ºå¯¹é¢æ˜¯windowså•Šï¼Œå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šï¼

å¥½åœ¨ä¹Ÿæœ‰åŠ¨æ€è·å–å®‰è£…è·¯å¾„çš„æ³•å­ï¼
è¿™å°±ç®—æå®šäº†ï¼

## é—®é¢˜6ï¼šæ€ä¹ˆä¹Ÿèƒ½æ˜¾ç¤ºè¿›åº¦å’Œæ•´ä½“æƒ…å†µï¼

æœ‹å‹è¯´ï¼Œæˆ‘è¿™ä¸çŸ¥é“æ€»å…±å‡ ä¸ªé“¾æ¥ï¼Œä¹Ÿä¸æ™“å¾—æˆåŠŸå’Œå¤±è´¥å‡ ä¸ªå•Šï¼
å•Šï¼
æ˜¯ï¼
å†åŠ ä¸ªæ—¥å¿—ç®¡ç†å™¨ï¼
è¿™æ ·ï¼Œæ¯åˆ°ä¸€ä¸ªæ­¥éª¤ï¼Œæ§åˆ¶å°è¾“å‡ºï¼Œæœ€ç»ˆè¿˜ç»™ä¸€ä¸ªæ€»çš„ï¼Œå¦‚æœå¤±è´¥çš„è¯ï¼Œæ˜¯å“ªä¸ªé“¾æ¥å¤±è´¥äº†ï¼Œè¿™æ ·æ‰‹åŠ¨ä¸‹è½½ï¼Œä¹Ÿæ˜¯ä¸é”™çš„ï¼
ä¸‹æ¬¡çŸ¥é“äº†ï¼å‘½ä»¤å°½é‡ä¹ŸåŠ ä¸ªæ—¥å¿—ç³»ç»Ÿï¼Œè¾“å‡ºä¹Ÿé…·ï¼Œæœ‰é”™è¯¯ä¹Ÿä¸æ€•ï¼

## ä¸‹é¢è¯´ä»£ç äº†

### bin/down-paper.js

é¦–å…ˆæ˜¯æ”¯æŒå‘½ä»¤ï¼Œé¡¹ç›®é‡Œå»ºä¸ª`bin/down-paper.js`ï¼Œå‚æ•°å’Œæ”¯æŒé€‰é¡¹

![down_paper4.png](https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/down_paper4.png)

![down_paper5.png](https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/down_paper4.png)

```js
#!/usr/bin/env node

const { runBatchPDFGeneration } = require('../lib/batchProcessor');
const path = require('path');

/**
 * CLI å‘½ä»¤è¡Œå·¥å…·
 * æ”¯æŒé€šè¿‡å‘½ä»¤è¡Œå‚æ•°é…ç½®å’Œè¿è¡Œæ‰¹é‡PDFç”Ÿæˆä»»åŠ¡
 */

// è§£æå‘½ä»¤è¡Œå‚æ•°
function parseArgs() {
  const args = process.argv.slice(2);
  const options = {};
  
  for (let i = 0; i < args.length; i++) {
    const arg = args[i];
    
    switch (arg) {
      case '--cookie':
      case '-c':
        options.cookie = args[++i];
        break;
      case '--subject-id':
      case '-s':
        options.subjectId = parseInt(args[++i]);
        break;
      case '--grade':
      case '-g':
        options.grade = args[++i];
        break;
      case '--quarter':
      case '-q':
        options.quarter = parseInt(args[++i]);
        break;
      case '--use-scene':
      case '-u':
        options.useScene = args[++i];
        break;
      case '--output-dir':
      case '-o':
        options.outputDir = args[++i];
        break;
      case '--headless':
        options.headless = true;
        break;
      case '--help':
      case '-h':
        showHelp();
        process.exit(0);
        break;
      case '--version':
      case '-v':
        console.log(require('../package.json').version);
        process.exit(0);
        break;
      default:
        if (arg.startsWith('--')) {
          console.error(`æœªçŸ¥å‚æ•°: ${arg}`);
          showHelp();
          process.exit(1);
        }
        break;
    }
  }
  
  return options;
}

// æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
function showHelp() {
  console.log(`
ğŸ“š æ‰¹é‡ä¸‹è½½è¯•å·PDFå·¥å…·

ç”¨æ³•:
  down-paper [é€‰é¡¹]

é€‰é¡¹:
  -c, --cookie <string>        Cookieå­—ç¬¦ä¸² (å¿…éœ€)
  -s, --subject-id <number>    ç§‘ç›®ID (é»˜è®¤: 1574)
  -g, --grade <string>         å¹´çº§ (é»˜è®¤: 0557)
  -q, --quarter <number>       å­¦æœŸ (é»˜è®¤: 3)
  -u, --use-scene <string>     ä½¿ç”¨åœºæ™¯ (é»˜è®¤: khlx)
  -o, --output-dir <string>    è¾“å‡ºç›®å½• (é»˜è®¤: ./1-download)
  --headless                   ä½¿ç”¨æ— å¤´æ¨¡å¼è¿è¡Œæµè§ˆå™¨ (é€‚åˆæœåŠ¡å™¨ç¯å¢ƒ)
  -h, --help                   æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
  -v, --version                æ˜¾ç¤ºç‰ˆæœ¬å·

ç¤ºä¾‹:
  # åŸºæœ¬ç”¨æ³•ï¼ˆä½¿ç”¨é»˜è®¤è¾“å‡ºç›®å½•ï¼‰
  down-paper --cookie "your-cookie-string"

  # æŒ‡å®šè‡ªå®šä¹‰è¾“å‡ºç›®å½•ï¼ˆæ¨èï¼‰
  # Linux/macOS:
  down-paper --cookie "your-cookie-string" --output-dir "./my-papers"
  # Windows:
  down-paper --cookie "your-cookie-string" --output-dir ".\\my-papers"

  # æŒ‡å®šå¹´çº§å’Œè¾“å‡ºç›®å½•
  down-paper --cookie "your-cookie-string" --grade "0558" --output-dir "./downloads"

  # æŒ‡å®šæ‰€æœ‰å‚æ•°
  down-paper --cookie "your-cookie-string" --subject-id 1574 --grade "0557" --quarter 3 --use-scene "khlx" --output-dir "./downloads"

  # ä½¿ç”¨æ— å¤´æ¨¡å¼ï¼ˆé€‚åˆæœåŠ¡å™¨ç¯å¢ƒï¼‰
  down-paper --cookie "your-cookie-string" --headless --output-dir "./downloads"

å¹´çº§ä»£ç :
  0555 - S3          0556 - S4          0557 - ä¸€å¹´çº§
  0558 - äºŒå¹´çº§      0559 - ä¸‰å¹´çº§      0560 - å››å¹´çº§
  0561 - äº”å¹´çº§      0562 - å…­å¹´çº§      0567 - ä¸åŒºåˆ†
  0999 - å°å‡åˆ

ä½¿ç”¨åœºæ™¯:
  gdk   - åŠŸåº•è€ƒ      jdcp  - é˜¶æ®µæµ‹è¯•      khlx  - è¯¾åæµ‹è¯•
  nlcp  - èƒ½åŠ›æµ‹è¯„    syttl - ç´ å…»å¤©å¤©ç»ƒ

å­¦æœŸä»£ç :
  1 - æ˜¥å­£           2 - æš‘å‡           3 - ç§‹å­£
  4 - å¯’å‡           9 - ä¸åŒºåˆ†
`);
}

// éªŒè¯å¿…éœ€å‚æ•°
function validateOptions(options) {
  if (!options.cookie) {
    console.error('âŒ é”™è¯¯: å¿…é¡»æä¾› --cookie å‚æ•°');
    console.log('ä½¿ç”¨ --help æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯');
    process.exit(1);
  }
}

// ä¸»å‡½æ•°
async function main() {
  try {
    console.log('ğŸš€ æ‰¹é‡ä¸‹è½½è¯•å·PDFå·¥å…·å¯åŠ¨ä¸­...\n');
    
    // æ˜¾ç¤ºé‡è¦æé†’
    console.log('âš ï¸  é‡è¦æé†’:');
    console.log('   å»ºè®®ä½¿ç”¨ --output-dir å‚æ•°æŒ‡å®šè¾“å‡ºç›®å½•');
    console.log('   é»˜è®¤ä¼šåœ¨å½“å‰ç›®å½•åˆ›å»º 1-download æ–‡ä»¶å¤¹\n');
    
    const options = parseArgs();
    validateOptions(options);
    
    // æ„å»ºé…ç½®å¯¹è±¡
    const config = {
      cookie: options.cookie,
      queryParams: {
        subjectId: options.subjectId || 1574,
        useScene: options.useScene || 'khlx',
        grade: options.grade || '0557',
        quarter: options.quarter || 3
      },
      outputDir: options.outputDir || './1-download',
      headless: options.headless || false
    };
    
    console.log('ğŸ“‹ é…ç½®ä¿¡æ¯:');
    console.log(`   ç§‘ç›®ID: ${config.queryParams.subjectId}`);
    console.log(`   å¹´çº§: ${config.queryParams.grade}`);
    console.log(`   å­¦æœŸ: ${config.queryParams.quarter}`);
    console.log(`   ä½¿ç”¨åœºæ™¯: ${config.queryParams.useScene}`);
    console.log(`   è¾“å‡ºç›®å½•: ${config.outputDir}`);
    console.log(`   æ— å¤´æ¨¡å¼: ${config.headless ? 'æ˜¯' : 'å¦'}`);
    console.log(`   Cookie: ${config.cookie.substring(0, 50)}...`);
    console.log('');
    
    // æ‰§è¡Œæ‰¹é‡PDFç”Ÿæˆ
    const result = await runBatchPDFGeneration(config);
    
    console.log('\nğŸ‰ ä»»åŠ¡å®Œæˆ!');
    console.log(`   æ€»è®¡: ${result.total} ä¸ªä»»åŠ¡`);
    console.log(`   æˆåŠŸ: ${result.success} ä¸ª`);
    console.log(`   å¤±è´¥: ${result.failed} ä¸ª`);
    console.log(`   è€—æ—¶: ${(result.duration / 1000).toFixed(2)} ç§’`);
    
    if (result.failed > 0) {
      console.log('\nâŒ å¤±è´¥çš„é“¾æ¥:');
      result.failedLinks.forEach(link => {
        console.log(`   ${link.index}. ${link.url}`);
        console.log(`      é”™è¯¯: ${link.error}`);
      });
    }
    
  } catch (error) {
    console.error('âŒ æ‰§è¡Œå¤±è´¥:', error.message);
    if (process.env.DEBUG) {
      console.error(error.stack);
    }
    process.exit(1);
  }
}

// å¦‚æœç›´æ¥è¿è¡Œæ­¤æ–‡ä»¶ï¼Œåˆ™æ‰§è¡Œä¸»å‡½æ•°
if (require.main === module) {
  main();
}

module.exports = { main, parseArgs, showHelp };

```

## ğŸ“ lib/ ç›®å½•ä»£ç é€»è¾‘è¯¦è§£

libç›®å½•åŒ…å«äº†å‘å¸ƒåˆ°npmåŒ…ä¸­çš„æ ¸å¿ƒä»£ç ï¼Œè¿™äº›æ–‡ä»¶æ˜¯ä»srcç›®å½•æ„å»ºè€Œæ¥çš„ã€‚ä¸‹é¢è¯¦ç»†åˆ†ææ¯ä¸ªæ–‡ä»¶çš„é€»è¾‘ï¼š

### 1. lib/index.js - APIå…¥å£æ–‡ä»¶

è¿™æ˜¯npmåŒ…çš„APIå…¥å£æ–‡ä»¶ï¼Œæä¾›äº†ç¨‹åºåŒ–è°ƒç”¨çš„æ¥å£ï¼š

```javascript
/**
 * æ‰¹é‡ä¸‹è½½è¯•å·PDFå·¥å…· - ä¸»å…¥å£æ–‡ä»¶
 * 
 * è¿™ä¸ªæ–‡ä»¶æä¾›äº†ä¸¤ç§ä½¿ç”¨æ–¹å¼ï¼š
 * 1. ä½œä¸ºCLIå·¥å…·ç›´æ¥è¿è¡Œ
 * 2. ä½œä¸ºæ¨¡å—è¢«å…¶ä»–æ–‡ä»¶å¼•ç”¨
 */

const { runBatchPDFGeneration } = require('./batchProcessor');

// å¦‚æœç›´æ¥è¿è¡Œæ­¤æ–‡ä»¶ï¼Œåˆ™æ‰§è¡Œé»˜è®¤é…ç½®
if (require.main === module) {
  console.log('ğŸš€ æ‰¹é‡ä¸‹è½½è¯•å·PDFå·¥å…·');
  console.log('ğŸ“ ä½¿ç”¨é»˜è®¤é…ç½®è¿è¡Œ...\n');
  
  console.log('âš ï¸  é‡è¦æé†’:');
  console.log('   å·¥å…·ä¼šåœ¨å½“å‰ç›®å½•åˆ›å»º 1-download æ–‡ä»¶å¤¹');
  console.log('   å»ºè®®ä½¿ç”¨ --output-dir å‚æ•°æŒ‡å®šè‡ªå®šä¹‰è¾“å‡ºç›®å½•\n');
  
  const params = {
    
    queryParams: {
      // è„‘åŠ›ä¸æ€ç»´
      subjectId: 1574,
      // è¯¾åæµ‹è¯•
      useScene: 'khlx',
      // ä¸€å¹´çº§ 0557 äºŒå¹´çº§ 0558 ä¸‰å¹´çº§ 0559 å››å¹´çº§ 0560
      grade: '0559',
      // ç§‹å­£
      quarter: 3,
      // æ¯é¡µ300æ¡
      pageSize: 300
    },
  }
  
  runBatchPDFGeneration(params)
    .then(result => {
      console.log('\nğŸ‰ ä»»åŠ¡å®Œæˆ!');
      console.log(`   æ€»è®¡: ${result.total} ä¸ªä»»åŠ¡`);
      console.log(`   æˆåŠŸ: ${result.success} ä¸ª`);
      console.log(`   å¤±è´¥: ${result.failed} ä¸ª`);
      console.log(`   è€—æ—¶: ${(result.duration / 1000).toFixed(2)} ç§’`);
    })
    .catch(error => {
      console.error('âŒ æ‰§è¡Œå¤±è´¥:', error.message);
      process.exit(1);
    });
}

// å¯¼å‡ºæ–¹æ³•ä¾›å…¶ä»–æ–‡ä»¶è°ƒç”¨
module.exports = { runBatchPDFGeneration };
```

**åŠŸèƒ½è¯´æ˜ï¼š**
- ä½œä¸ºnpmåŒ…çš„APIå…¥å£ç‚¹
- æä¾›`runBatchPDFGeneration`å‡½æ•°çš„å¯¼å‡º
- æ”¯æŒç›´æ¥è¿è¡Œï¼ˆä½¿ç”¨é»˜è®¤é…ç½®ï¼‰
- æ”¯æŒä½œä¸ºæ¨¡å—è¢«å…¶ä»–é¡¹ç›®å¼•ç”¨

### 2. lib/batchProcessor.js - æ‰¹é‡å¤„ç†æ ¸å¿ƒé€»è¾‘

è¿™æ˜¯æ•´ä¸ªå·¥å…·çš„æ ¸å¿ƒæ–‡ä»¶ï¼Œè´Ÿè´£åè°ƒæ•´ä¸ªæ‰¹é‡ä¸‹è½½æµç¨‹ï¼š

```javascript
const { processIframeAndGeneratePDF } = require('./iframeProcessor');
const { getPapersList, createLinkArr } = require('./request');
const logger = require('./logger');

/**
 * æ‰¹é‡PDFç”Ÿæˆä»»åŠ¡
 * @param {Object} options - é…ç½®é€‰é¡¹
 * @param {string} options.cookie - Cookieå­—ç¬¦ä¸²
 * @param {Object} options.queryParams - æŸ¥è¯¢å‚æ•°
 * @param {number} options.queryParams.subjectId - ç§‘ç›®IDï¼ˆé»˜è®¤ï¼š1574ï¼‰
 * @param {string} options.queryParams.useScene - ä½¿ç”¨åœºæ™¯ï¼ˆé»˜è®¤ï¼š'khlx'ï¼‰
 * @param {string} options.queryParams.grade - å¹´çº§ï¼ˆé»˜è®¤ï¼š'0557'ï¼‰
 * @param {number} options.queryParams.quarter - å­¦æœŸï¼ˆé»˜è®¤ï¼š3ï¼‰
 * @param {string} options.downloadSelector - ä¸‹è½½æŒ‰é’®é€‰æ‹©å™¨
 * @param {string} options.printSelector - æ‰“å°æŒ‰é’®é€‰æ‹©å™¨
 * @param {string} options.textSelector - æ–‡æœ¬é€‰æ‹©å™¨
 * @param {string} options.checkboxSelector - å¤é€‰æ¡†é€‰æ‹©å™¨
 * @param {Array} options.checkboxIndexes - å¤é€‰æ¡†ç´¢å¼•æ•°ç»„
 * @param {string} options.outputDir - è¾“å‡ºç›®å½•
 * @returns {Promise<Object>} è¿”å›æ‰§è¡Œç»“æœç»Ÿè®¡
 */
async function runBatchPDFGeneration(options = {}) {
  const startTime = Date.now();
  let successCount = 0;
  let failedCount = 0;
  const failedLinks = [];
  
  // é»˜è®¤é…ç½®
  const defaultOptions = {
    queryParams: {
      subjectId: 1574,
      useScene: 'khlx',
      grade: '0557',
      quarter: 3
    },
    downloadSelector: '#app .source_main_box .title .title-right .top-name-div .print-btn',
    printSelector: '.down-info .down-info-btn .print-btn',
    textSelector: '.x-text',
    checkboxSelector: '.down-type-container-info .el-checkbox',
    checkboxIndexes: [1, 2],
    outputDir: ''
  };

  // åˆå¹¶é…ç½®
  const config = { ...defaultOptions, ...options };
  const { cookie, queryParams, ...otherOptions } = config;
  
  logger.info('å¼€å§‹æ‰¹é‡PDFç”Ÿæˆä»»åŠ¡', { 
    startTime: new Date().toISOString(),
    config: {
      ...config,
      cookie: cookie ? '***å·²è®¾ç½®***' : 'æœªè®¾ç½®'
    }
  });

  try {
    // 1. è·å–è¯•å·åˆ—è¡¨
    logger.info('æ­£åœ¨è·å–è¯•å·åˆ—è¡¨...');
    const papersList = await getPapersList(queryParams, cookie);
    logger.info(`æˆåŠŸè·å–åˆ° ${papersList.length} ä¸ªè¯•å·`);

    // 2. åˆ›å»ºä¸‹è½½é“¾æ¥æ•°ç»„
    const linkArr = createLinkArr(papersList);
    logger.info(`åˆ›å»ºäº† ${linkArr.length} ä¸ªä¸‹è½½é“¾æ¥`);

    // 3. æ‰¹é‡å¤„ç†PDFç”Ÿæˆ
    logger.info('å¼€å§‹æ‰¹é‡å¤„ç†PDFç”Ÿæˆ...');
    
    for (let i = 0; i < linkArr.length; i++) {
      const link = linkArr[i];
      const index = i + 1;
      
      logger.info(`å¤„ç†ç¬¬ ${index}/${linkArr.length} ä¸ªé“¾æ¥`, { 
        url: link.url,
        title: link.title 
      });

      try {
        await processIframeAndGeneratePDF({
          ...link,
          ...otherOptions,
          index
        });
        
        successCount++;
        logger.success(`ç¬¬ ${index} ä¸ªé“¾æ¥å¤„ç†æˆåŠŸ`, { url: link.url });
        
      } catch (error) {
        failedCount++;
        failedLinks.push({
          index,
          url: link.url,
          title: link.title,
          error: error.message
        });
        logger.error(`ç¬¬ ${index} ä¸ªé“¾æ¥å¤„ç†å¤±è´¥`, { 
          url: link.url,
          error: error.message 
        });
      }
      
      // æ·»åŠ å»¶è¿Ÿé¿å…è¯·æ±‚è¿‡äºé¢‘ç¹
      if (i < linkArr.length - 1) {
        await new Promise(resolve => setTimeout(resolve, 1000));
      }
    }

    // 4. ç”Ÿæˆæ‰§è¡Œç»“æœ
    const endTime = Date.now();
    const duration = endTime - startTime;
    
    const result = {
      total: linkArr.length,
      success: successCount,
      failed: failedCount,
      duration,
      failedLinks,
      startTime: new Date(startTime).toISOString(),
      endTime: new Date(endTime).toISOString()
    };

    logger.info('æ‰¹é‡PDFç”Ÿæˆä»»åŠ¡å®Œæˆ', result);
    return result;

  } catch (error) {
    logger.error('æ‰¹é‡PDFç”Ÿæˆä»»åŠ¡å¤±è´¥', { error: error.message });
    throw error;
  }
}

module.exports = { runBatchPDFGeneration };
```

**åŠŸèƒ½è¯´æ˜ï¼š**
- åè°ƒæ•´ä¸ªæ‰¹é‡ä¸‹è½½æµç¨‹
- ç®¡ç†è¯•å·åˆ—è¡¨è·å–å’Œé“¾æ¥åˆ›å»º
- æ§åˆ¶å¹¶å‘å¤„ç†å’Œé”™è¯¯å¤„ç†
- ç”Ÿæˆè¯¦ç»†çš„æ‰§è¡ŒæŠ¥å‘Šå’Œç»Ÿè®¡ä¿¡æ¯

### 3. lib/pdfGenerator.js - PDFç”Ÿæˆæ ¸å¿ƒé€»è¾‘

è´Ÿè´£å•ä¸ªPDFæ–‡ä»¶çš„ç”Ÿæˆï¼ŒåŒ…æ‹¬é¡µé¢æ“ä½œå’ŒPDFå¯¼å‡ºï¼š

```javascript
const puppeteer = require('puppeteer');
const fs = require('fs');
const path = require('path');
const logger = require('./logger');
const { getBrowserOptions, getPlatformInfo } = require('./browserConfig');
const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

/**
 * ç”ŸæˆPDFæ–‡ä»¶çš„æ–¹æ³•
 * @param {Object} options - é…ç½®é€‰é¡¹
 * @param {string} options.url - è¦è®¿é—®çš„URL
 * @param {Array} options.cookies - Cookieæ•°ç»„
 * @param {string} options.textSelector - ç”¨äºç”Ÿæˆæ–‡ä»¶åçš„æ–‡æœ¬é€‰æ‹©å™¨
 * @param {string} options.checkboxSelector - å¤é€‰æ¡†é€‰æ‹©å™¨
 * @param {Array} options.checkboxIndexes - è¦ç‚¹å‡»çš„å¤é€‰æ¡†ç´¢å¼•æ•°ç»„
 * @param {string} options.outputDir - è¾“å‡ºç›®å½•
 * @param {boolean} options.headless - æ˜¯å¦æ— å¤´æ¨¡å¼
 * @returns {Promise<Object>} è¿”å›ç”Ÿæˆçš„æ–‡ä»¶ä¿¡æ¯
 */
async function generatePDF(options) {
  let {
    url,
    cookies = [],
    textSelector = '.x-text',
    checkboxSelector = '.down-type-container-info .el-checkbox',
    checkboxIndexes = [1, 2],
    outputDir = './download/',
    headless = false
  } = options;

  // å‚æ•°éªŒè¯
  if (!url) {
    const error = new Error('URLå‚æ•°æ˜¯å¿…éœ€çš„');
    logger.error('generatePDFå‚æ•°éªŒè¯å¤±è´¥', { error: error.message });
    throw error;
  }

  // ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨å¹¶æ ¼å¼åŒ–è·¯å¾„
  if (outputDir) {
    let normalizedOutputDir = path.normalize(outputDir);
    if (!normalizedOutputDir.endsWith(path.sep)) {
      normalizedOutputDir += path.sep;
    }
    
    if (!fs.existsSync(normalizedOutputDir)) {
      fs.mkdirSync(normalizedOutputDir, { recursive: true });
      logger.info('åˆ›å»ºè¾“å‡ºç›®å½•', { outputDir: normalizedOutputDir });
    }
    
    outputDir = normalizedOutputDir;
  }

  logger.info('å¼€å§‹PDFç”Ÿæˆæµç¨‹', { url, textSelector, checkboxSelector, checkboxIndexes });

  let browser;
  try {
    // å¯åŠ¨æµè§ˆå™¨
    logger.info('å¯åŠ¨æµè§ˆå™¨');
    
    // è·å–è·¨å¹³å°æµè§ˆå™¨é…ç½®
    const browserOptions = getBrowserOptions({ headless });
    const platformInfo = getPlatformInfo();
    
    // è®°å½•æµè§ˆå™¨é…ç½®ä¿¡æ¯
    logger.info('æµè§ˆå™¨é…ç½®', { 
      platform: platformInfo.platform,
      arch: platformInfo.arch,
      executablePath: browserOptions.executablePath || 'ä½¿ç”¨é»˜è®¤è·¯å¾„',
      headless: browserOptions.headless,
      chromeAvailable: platformInfo.chromeAvailable
    });
    
    browser = await puppeteer.launch(browserOptions);
    logger.success('æµè§ˆå™¨å¯åŠ¨æˆåŠŸ');

    const page = await browser.newPage();
    
    // è®¾ç½®Cookie
    if (cookies && cookies.length > 0) {
      logger.info('è®¾ç½®Cookie', { count: cookies.length });
      await page.setCookie(...cookies);
    }

    // è®¿é—®é¡µé¢
    logger.info('è®¿é—®é¡µé¢', { url });
    await page.goto(url, { waitUntil: 'networkidle2', timeout: 30000 });
    
    // ç­‰å¾…é¡µé¢åŠ è½½
    await sleep(2000);
    
    // æŸ¥æ‰¾æ–‡æœ¬å…ƒç´ 
    const textElement = await page.$(textSelector);
    if (!textElement) {
      throw new Error(`æœªæ‰¾åˆ°æ–‡æœ¬å…ƒç´ : ${textSelector}`);
    }
    
    // è·å–æ–‡ä»¶å
    const fileName = await textElement.evaluate(el => el.textContent.trim());
    logger.info('è·å–åˆ°æ–‡ä»¶å', { fileName });
    
    // æŸ¥æ‰¾å¤é€‰æ¡†
    const checkboxes = await page.$$(checkboxSelector);
    if (checkboxes.length === 0) {
      throw new Error(`æœªæ‰¾åˆ°å¤é€‰æ¡†: ${checkboxSelector}`);
    }
    
    logger.info('æ‰¾åˆ°å¤é€‰æ¡†', { count: checkboxes.length });
    
    // ç”Ÿæˆç¬¬ä¸€ä¸ªPDFï¼ˆä¸åŒ…å«ç­”æ¡ˆï¼‰
    const result = { files: [] };
    
    try {
      // å–æ¶ˆé€‰æ‹©æ‰€æœ‰å¤é€‰æ¡†
      for (let i = 0; i < checkboxes.length; i++) {
        const isChecked = await checkboxes[i].evaluate(el => el.checked);
        if (isChecked) {
          await checkboxes[i].click();
          await sleep(500);
        }
      }
      
      // ç”ŸæˆPDF
      const pdfBuffer = await page.pdf({
        format: 'A4',
        printBackground: false,
        displayHeaderFooter: false
      });

      const filePath1 = path.join(outputDir, `${fileName}.pdf`);
      fs.writeFileSync(filePath1, pdfBuffer);
      const fileSize = fs.statSync(filePath1).size;
      logger.logPDFSuccess(fileName, filePath1, fileSize);
      result.files.push(filePath1);
    } catch (error) {
      logger.error('ç”Ÿæˆç¬¬ä¸€ä¸ªPDFå¤±è´¥', { error: error.message });
    }
    
    // ç”Ÿæˆç¬¬äºŒä¸ªPDFï¼ˆåŒ…å«ç­”æ¡ˆï¼‰
    if (checkboxIndexes.length > 0) {
      try {
        // é€‰æ‹©æŒ‡å®šçš„å¤é€‰æ¡†
        for (const index of checkboxIndexes) {
          if (index <= checkboxes.length) {
            const checkbox = checkboxes[index - 1];
            const isChecked = await checkbox.evaluate(el => el.checked);
            if (!isChecked) {
              await checkbox.click();
              await sleep(500);
            }
          }
        }
        
        // ç­‰å¾…é¡µé¢æ›´æ–°
        await sleep(1000);
        
        // ç”ŸæˆåŒ…å«ç­”æ¡ˆçš„PDF
        const pdfBuffer2 = await page.pdf({
          format: 'A4',
          printBackground: false,
          displayHeaderFooter: false
        });
        
        const filePath2 = path.join(outputDir, `${fileName}-ç­”æ¡ˆ.pdf`);
        fs.writeFileSync(filePath2, pdfBuffer2);
        const fileSize2 = fs.statSync(filePath2).size;
        logger.logPDFSuccess(`${fileName}-ç­”æ¡ˆ`, filePath2, fileSize2);
        result.files.push(filePath2);
      } else {
        logger.warn('æœªæ‰¾åˆ°ç­”æ¡ˆå¤é€‰æ¡†ï¼Œè·³è¿‡ç­”æ¡ˆPDFç”Ÿæˆ');
      }
    }
    
    logger.success('PDFç”Ÿæˆå®Œæˆ', { 
      fileName, 
      files: result.files.length,
      totalSize: result.files.reduce((sum, file) => sum + fs.statSync(file).size, 0)
    });
    
    return result;
    
  } catch (error) {
    logger.error('PDFç”Ÿæˆå¤±è´¥', { error: error.message, url });
    throw error;
  } finally {
    if (browser) {
      await browser.close();
      logger.info('æµè§ˆå™¨å·²å…³é—­');
    }
  }
}

module.exports = { generatePDF };
```

**åŠŸèƒ½è¯´æ˜ï¼š**
- å¯åŠ¨å’Œç®¡ç†Puppeteeræµè§ˆå™¨å®ä¾‹
- å¤„ç†é¡µé¢äº¤äº’ï¼ˆç‚¹å‡»å¤é€‰æ¡†ï¼‰
- ç”ŸæˆPDFæ–‡ä»¶ï¼ˆåŒ…å«ç­”æ¡ˆå’Œä¸åŒ…å«ç­”æ¡ˆä¸¤ä¸ªç‰ˆæœ¬ï¼‰
- è·¨å¹³å°è·¯å¾„å¤„ç†
- é”™è¯¯å¤„ç†å’Œèµ„æºæ¸…ç†

### 4. lib/browserConfig.js - è·¨å¹³å°æµè§ˆå™¨é…ç½®

æä¾›è·¨å¹³å°çš„æµè§ˆå™¨é…ç½®å’Œè·¯å¾„æ£€æµ‹ï¼š

```javascript
const os = require('os');
const fs = require('fs');
const path = require('path');

/**
 * è·å–è·¨å¹³å°çš„ Chrome æµè§ˆå™¨è·¯å¾„
 * @returns {string|null} Chrome å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ï¼Œå¦‚æœæœªæ‰¾åˆ°åˆ™è¿”å› null
 */
function getChromeExecutablePath() {
  const platform = os.platform();
  
  if (platform === 'darwin') {
    // macOS
    const macPath = '/Applications/Google Chrome.app/Contents/MacOS/Google Chrome';
    if (fs.existsSync(macPath)) {
      return macPath;
    }
  } else if (platform === 'win32') {
    // Windows - å°è¯•å¸¸è§çš„ Chrome å®‰è£…è·¯å¾„
    const possiblePaths = [
      'C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe',
      'C:\\Program Files (x86)\\Google\\Chrome\\Application\\chrome.exe',
      path.join(process.env.LOCALAPPDATA || '', 'Google\\Chrome\\Application\\chrome.exe'),
      path.join(process.env.PROGRAMFILES || '', 'Google\\Chrome\\Application\\chrome.exe'),
      path.join(process.env['PROGRAMFILES(X86)'] || '', 'Google\\Chrome\\Application\\chrome.exe')
    ];
    
    for (const chromePath of possiblePaths) {
      if (chromePath && fs.existsSync(chromePath)) {
        return chromePath;
      }
    }
  } else if (platform === 'linux') {
    // Linux - å°è¯•å¸¸è§çš„ Chrome å®‰è£…è·¯å¾„
    const possiblePaths = [
      '/usr/bin/google-chrome',
      '/usr/bin/google-chrome-stable',
      '/usr/bin/chromium-browser',
      '/usr/bin/chromium',
      '/snap/bin/chromium'
    ];
    
    for (const chromePath of possiblePaths) {
      if (fs.existsSync(chromePath)) {
        return chromePath;
      }
    }
  }
  
  return null; // æœªæ‰¾åˆ° Chromeï¼Œä½¿ç”¨ Puppeteer é»˜è®¤è·¯å¾„
}

/**
 * è·å–è·¨å¹³å°çš„æµè§ˆå™¨å¯åŠ¨é…ç½®
 * @param {Object} options - æµè§ˆå™¨é…ç½®é€‰é¡¹
 * @param {boolean} options.headless - æ˜¯å¦æ— å¤´æ¨¡å¼
 * @param {Array} options.args - é¢å¤–çš„å¯åŠ¨å‚æ•°
 * @returns {Object} æµè§ˆå™¨å¯åŠ¨é…ç½®
 */
function getBrowserOptions(options = {}) {
  const { headless = true, args = [] } = options;
  
  const browserOptions = {
    headless,
    args: [
      '--no-sandbox',
      '--disable-setuid-sandbox',
      '--disable-dev-shm-usage',
      '--disable-accelerated-2d-canvas',
      '--no-first-run',
      '--no-zygote',
      '--disable-gpu',
      ...args
    ]
  };
  
  // å°è¯•è®¾ç½® Chrome è·¯å¾„
  const chromePath = getChromeExecutablePath();
  if (chromePath) {
    browserOptions.executablePath = chromePath;
  }
  
  return browserOptions;
}

/**
 * æ£€æŸ¥ Chrome æ˜¯å¦å¯ç”¨
 * @returns {boolean} Chrome æ˜¯å¦å¯ç”¨
 */
function isChromeAvailable() {
  return getChromeExecutablePath() !== null;
}

/**
 * è·å–å½“å‰å¹³å°ä¿¡æ¯
 * @returns {Object} å¹³å°ä¿¡æ¯
 */
function getPlatformInfo() {
  return {
    platform: os.platform(),
    arch: os.arch(),
    chromePath: getChromeExecutablePath(),
    chromeAvailable: isChromeAvailable()
  };
}

module.exports = {
  getChromeExecutablePath,
  getBrowserOptions,
  isChromeAvailable,
  getPlatformInfo
};
```

**åŠŸèƒ½è¯´æ˜ï¼š**
- è·¨å¹³å°Chromeè·¯å¾„æ£€æµ‹ï¼ˆWindowsã€macOSã€Linuxï¼‰
- æµè§ˆå™¨å¯åŠ¨é…ç½®ç”Ÿæˆ
- å¹³å°ä¿¡æ¯è·å–
- Chromeå¯ç”¨æ€§æ£€æŸ¥

### 5. lib/request.js - HTTPè¯·æ±‚å¤„ç†

è´Ÿè´£ä¸APIé€šä¿¡ï¼Œè·å–è¯•å·åˆ—è¡¨ï¼š

```javascript
const https = require('https');
const logger = require('./logger');

/**
 * è·å–è¯•å·åˆ—è¡¨
 * @param {Object} params - æŸ¥è¯¢å‚æ•°
 * @param {string} cookies - Cookieå­—ç¬¦ä¸²
 * @returns {Promise<Array>} è¯•å·åˆ—è¡¨
 */
async function getPapersList(params = {}, cookies) {
  if (!cookies) {
    throw new Error('cookieså‚æ•°æ˜¯å¿…éœ€çš„');
  }

  const queryParams = new URLSearchParams({
    subjectId: params.subjectId || 1574,
    useScene: params.useScene || 'khlx',
    grade: params.grade || '0557',
    quarter: params.quarter || 3,
    pageSize: params.pageSize || 300,
    pageNum: 1
  });

  const url = `https://api.xdf.cn/paper/list?${queryParams.toString()}`;
  
  logger.info('è¯·æ±‚è¯•å·åˆ—è¡¨', { url, params });

  return new Promise((resolve, reject) => {
    const options = {
      method: 'GET',
      headers: {
        'Cookie': cookies,
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
        'Accept': 'application/json, text/plain, */*',
        'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
        'Referer': 'https://www.xdf.cn/',
        'Origin': 'https://www.xdf.cn'
      }
    };

    const req = https.request(url, options, (res) => {
      let data = '';

      res.on('data', (chunk) => {
        data += chunk;
      });

      res.on('end', () => {
        try {
          const response = JSON.parse(data);
          if (response.code === 200 && response.data) {
            logger.info('è·å–è¯•å·åˆ—è¡¨æˆåŠŸ', { count: response.data.length });
            resolve(response.data);
          } else {
            logger.error('è·å–è¯•å·åˆ—è¡¨å¤±è´¥', { response });
            reject(new Error(`APIè¿”å›é”™è¯¯: ${response.message || 'æœªçŸ¥é”™è¯¯'}`));
          }
        } catch (error) {
          logger.error('è§£æè¯•å·åˆ—è¡¨å“åº”å¤±è´¥', { error: error.message, data });
          reject(error);
        }
      });
    });

    req.on('error', (error) => {
      logger.error('è¯·æ±‚è¯•å·åˆ—è¡¨å¤±è´¥', { error: error.message });
      reject(error);
    });

    req.setTimeout(30000, () => {
      req.destroy();
      reject(new Error('è¯·æ±‚è¶…æ—¶'));
    });

    req.end();
  });
}

/**
 * åˆ›å»ºä¸‹è½½é“¾æ¥æ•°ç»„
 * @param {Array} papersList - è¯•å·åˆ—è¡¨
 * @returns {Array} é“¾æ¥æ•°ç»„
 */
function createLinkArr(papersList) {
  const linkArr = [];
  
  papersList.forEach(paper => {
    if (paper.id && paper.title) {
      linkArr.push({
        id: paper.id,
        title: paper.title,
        url: `https://www.xdf.cn/paper/detail/${paper.id}`
      });
    }
  });
  
  logger.info('åˆ›å»ºä¸‹è½½é“¾æ¥æ•°ç»„', { count: linkArr.length });
  return linkArr;
}

module.exports = { getPapersList, createLinkArr };
```

**åŠŸèƒ½è¯´æ˜ï¼š**
- ä¸XDF APIé€šä¿¡è·å–è¯•å·åˆ—è¡¨
- å¤„ç†HTTPè¯·æ±‚å’Œå“åº”
- è§£æJSONæ•°æ®
- åˆ›å»ºä¸‹è½½é“¾æ¥æ•°ç»„

### 6. lib/logger.js - æ—¥å¿—ç³»ç»Ÿ

æä¾›ç»Ÿä¸€çš„æ—¥å¿—è®°å½•åŠŸèƒ½ï¼š

```javascript
const fs = require('fs');
const path = require('path');

class Logger {
  constructor() {
    this.logDir = path.join(process.cwd(), 'logs');
    this.ensureLogDir();
    this.logFile = path.join(this.logDir, `pdf-generator-${this.getDateString()}.log`);
  }

  ensureLogDir() {
    if (!fs.existsSync(this.logDir)) {
      fs.mkdirSync(this.logDir, { recursive: true });
    }
  }

  getDateString() {
    const now = new Date();
    return now.toISOString().split('T')[0]; // YYYY-MM-DD
  }

  getTimestamp() {
    return new Date().toISOString();
  }

  formatMessage(level, message, data = {}) {
    const timestamp = this.getTimestamp();
    const dataStr = Object.keys(data).length > 0 ? ` ${JSON.stringify(data)}` : '';
    return `[${timestamp}] [${level.toUpperCase()}] ${message}${dataStr}`;
  }

  writeToFile(message) {
    try {
      fs.appendFileSync(this.logFile, message + '\n');
    } catch (error) {
      console.error('å†™å…¥æ—¥å¿—æ–‡ä»¶å¤±è´¥:', error.message);
    }
  }

  info(message, data = {}) {
    const formattedMessage = this.formatMessage('info', message, data);
    console.log(`â„¹ï¸  ${message}`, data);
    this.writeToFile(formattedMessage);
  }

  success(message, data = {}) {
    const formattedMessage = this.formatMessage('success', message, data);
    console.log(`âœ… ${message}`, data);
    this.writeToFile(formattedMessage);
  }

  warn(message, data = {}) {
    const formattedMessage = this.formatMessage('warn', message, data);
    console.warn(`âš ï¸  ${message}`, data);
    this.writeToFile(formattedMessage);
  }

  error(message, data = {}) {
    const formattedMessage = this.formatMessage('error', message, data);
    console.error(`âŒ ${message}`, data);
    this.writeToFile(formattedMessage);
  }

  logPDFSuccess(fileName, filePath, fileSize) {
    const sizeKB = (fileSize / 1024).toFixed(2);
    const message = `PDFç”ŸæˆæˆåŠŸ: ${fileName}`;
    const data = { fileName, filePath, fileSize, sizeKB: `${sizeKB}KB` };
    
    const formattedMessage = this.formatMessage('success', message, data);
    console.log(`ğŸ“„ ${message} (${sizeKB}KB)`);
    this.writeToFile(formattedMessage);
  }
}

module.exports = new Logger();
```

**åŠŸèƒ½è¯´æ˜ï¼š**
- ç»Ÿä¸€çš„æ—¥å¿—è®°å½•æ¥å£
- æ–‡ä»¶å’Œæ§åˆ¶å°åŒé‡è¾“å‡º
- ä¸åŒçº§åˆ«çš„æ—¥å¿—ï¼ˆinfoã€successã€warnã€errorï¼‰
- æ—¶é—´æˆ³å’Œæ ¼å¼åŒ–è¾“å‡º

### 7. lib/iframeProcessor.js - iframeå¤„ç†é€»è¾‘

å¤„ç†åŒ…å«iframeçš„å¤æ‚é¡µé¢ç»“æ„ï¼š

```javascript
const puppeteer = require('puppeteer');
const { generatePDF } = require('./pdfGenerator');
const logger = require('./logger');
const { getBrowserOptions, getPlatformInfo } = require('./browserConfig');

/**
 * å¤„ç†iframeå¹¶ç”ŸæˆPDF
 * @param {Object} options - é…ç½®é€‰é¡¹
 * @param {string} options.url - é¡µé¢URL
 * @param {Array} options.cookies - Cookieæ•°ç»„
 * @param {string} options.textSelector - æ–‡æœ¬é€‰æ‹©å™¨
 * @param {string} options.checkboxSelector - å¤é€‰æ¡†é€‰æ‹©å™¨
 * @param {Array} options.checkboxIndexes - å¤é€‰æ¡†ç´¢å¼•
 * @param {string} options.outputDir - è¾“å‡ºç›®å½•
 * @param {boolean} options.headless - æ˜¯å¦æ— å¤´æ¨¡å¼
 * @param {number} options.index - ä»»åŠ¡ç´¢å¼•
 * @returns {Promise<Object>} å¤„ç†ç»“æœ
 */
async function processIframeAndGeneratePDF(options) {
  const { 
    url, 
    cookies = [], 
    textSelector = '.x-text', 
    checkboxSelector = '.down-type-container-info .el-checkbox', 
    checkboxIndexes = [1, 2], 
    outputDir = '',
    headless = true,
    index = 0
  } = options;

  logger.info('å¼€å§‹å¤„ç†iframeå’ŒPDFç”Ÿæˆ', { 
    index, 
    url, 
    textSelector, 
    checkboxSelector 
  });

  let browser;
  try {
    // å¯åŠ¨æµè§ˆå™¨ çª—å£æœ€å¤§åŒ–
    logger.info('å¯åŠ¨æµè§ˆå™¨ï¼ˆiframeå¤„ç†ï¼‰');
    
    // è·å–è·¨å¹³å°æµè§ˆå™¨é…ç½®
    const browserOptions = getBrowserOptions({ 
      headless: false,
      args: [
        '--window-size=2800,1200',
        '--start-maximized'
      ]
    });
    const platformInfo = getPlatformInfo();
    
    // è®°å½•æµè§ˆå™¨é…ç½®ä¿¡æ¯
    logger.info('æµè§ˆå™¨é…ç½®ï¼ˆiframeå¤„ç†ï¼‰', { 
      platform: platformInfo.platform,
      arch: platformInfo.arch,
      executablePath: browserOptions.executablePath || 'ä½¿ç”¨é»˜è®¤è·¯å¾„',
      chromeAvailable: platformInfo.chromeAvailable
    });
    
    browser = await puppeteer.launch(browserOptions);
    logger.success('æµè§ˆå™¨å¯åŠ¨æˆåŠŸï¼ˆiframeå¤„ç†ï¼‰');
    const page = await browser.newPage();

    // è®¾ç½®çª—å£å¤§å°
    await page.setViewport({ width: 1500, height: 1200 });

    // è®¾ç½®Cookie
    if (cookies && cookies.length > 0) {
      logger.info('è®¾ç½®Cookieï¼ˆiframeå¤„ç†ï¼‰', { count: cookies.length });
      await page.setCookie(...cookies);
    }

    // è®¿é—®é¡µé¢
    logger.info('è®¿é—®é¡µé¢ï¼ˆiframeå¤„ç†ï¼‰', { url });
    await page.goto(url, { waitUntil: 'networkidle2', timeout: 30000 });
    
    // ç­‰å¾…é¡µé¢åŠ è½½
    await sleep(3000);

    // æŸ¥æ‰¾iframe
    const iframe = await page.$('iframe');
    if (!iframe) {
      logger.warn('æœªæ‰¾åˆ°iframeï¼Œç›´æ¥å¤„ç†é¡µé¢');
      return await generatePDF({
        url,
        cookies,
        textSelector,
        checkboxSelector,
        checkboxIndexes,
        outputDir,
        headless
      });
    }

    logger.info('æ‰¾åˆ°iframeï¼Œå¼€å§‹å¤„ç†');

    // è·å–iframeå†…å®¹
    const frame = await iframe.contentFrame();
    if (!frame) {
      throw new Error('æ— æ³•è·å–iframeå†…å®¹');
    }

    // ç­‰å¾…iframeå†…å®¹åŠ è½½
    await sleep(2000);

    // åœ¨iframeä¸­æŸ¥æ‰¾æ–‡æœ¬å…ƒç´ 
    const textElement = await frame.$(textSelector);
    if (!textElement) {
      throw new Error(`åœ¨iframeä¸­æœªæ‰¾åˆ°æ–‡æœ¬å…ƒç´ : ${textSelector}`);
    }

    // è·å–æ–‡ä»¶å
    const fileName = await textElement.evaluate(el => el.textContent.trim());
    logger.info('è·å–åˆ°æ–‡ä»¶åï¼ˆiframeï¼‰', { fileName });

    // åœ¨iframeä¸­æŸ¥æ‰¾å¤é€‰æ¡†
    const checkboxes = await frame.$$(checkboxSelector);
    if (checkboxes.length === 0) {
      throw new Error(`åœ¨iframeä¸­æœªæ‰¾åˆ°å¤é€‰æ¡†: ${checkboxSelector}`);
    }

    logger.info('æ‰¾åˆ°å¤é€‰æ¡†ï¼ˆiframeï¼‰', { count: checkboxes.length });

    // ç”ŸæˆPDF
    const result = { files: [] };

    try {
      // å–æ¶ˆé€‰æ‹©æ‰€æœ‰å¤é€‰æ¡†
      for (let i = 0; i < checkboxes.length; i++) {
        const isChecked = await checkboxes[i].evaluate(el => el.checked);
        if (isChecked) {
          await checkboxes[i].click();
          await sleep(500);
        }
      }

      // ç”Ÿæˆç¬¬ä¸€ä¸ªPDFï¼ˆä¸åŒ…å«ç­”æ¡ˆï¼‰
      const pdfBuffer = await page.pdf({
        format: 'A4',
        printBackground: false,
        displayHeaderFooter: false
      });

      const filePath1 = path.join(outputDir, `${fileName}.pdf`);
      fs.writeFileSync(filePath1, pdfBuffer);
      const fileSize = fs.statSync(filePath1).size;
      logger.logPDFSuccess(fileName, filePath1, fileSize);
      result.files.push(filePath1);

      // ç”Ÿæˆç¬¬äºŒä¸ªPDFï¼ˆåŒ…å«ç­”æ¡ˆï¼‰
      if (checkboxIndexes.length > 0) {
        // é€‰æ‹©æŒ‡å®šçš„å¤é€‰æ¡†
        for (const index of checkboxIndexes) {
          if (index <= checkboxes.length) {
            const checkbox = checkboxes[index - 1];
            const isChecked = await checkbox.evaluate(el => el.checked);
            if (!isChecked) {
              await checkbox.click();
              await sleep(500);
            }
          }
        }

        // ç­‰å¾…é¡µé¢æ›´æ–°
        await sleep(1000);

        // ç”ŸæˆåŒ…å«ç­”æ¡ˆçš„PDF
        const pdfBuffer2 = await page.pdf({
          format: 'A4',
          printBackground: false,
          displayHeaderFooter: false
        });

        const filePath2 = path.join(outputDir, `${fileName}-ç­”æ¡ˆ.pdf`);
        fs.writeFileSync(filePath2, pdfBuffer2);
        const fileSize2 = fs.statSync(filePath2).size;
        logger.logPDFSuccess(`${fileName}-ç­”æ¡ˆ`, filePath2, fileSize2);
        result.files.push(filePath2);
      }

      logger.success('iframe PDFç”Ÿæˆå®Œæˆ', { 
        fileName, 
        files: result.files.length,
        totalSize: result.files.reduce((sum, file) => sum + fs.statSync(file).size, 0)
      });

      return result;

    } catch (error) {
      logger.error('iframe PDFç”Ÿæˆå¤±è´¥', { error: error.message });
      throw error;
    }

  } catch (error) {
    logger.error('iframeå¤„ç†å¤±è´¥', { error: error.message, url });
    throw error;
  } finally {
    if (browser) {
      await browser.close();
      logger.info('æµè§ˆå™¨å·²å…³é—­ï¼ˆiframeå¤„ç†ï¼‰');
    }
  }
}

module.exports = { processIframeAndGeneratePDF };
```

**åŠŸèƒ½è¯´æ˜ï¼š**
- å¤„ç†åŒ…å«iframeçš„å¤æ‚é¡µé¢
- åœ¨iframeå†…éƒ¨æŸ¥æ‰¾å’Œæ“ä½œå…ƒç´ 
- å¤„ç†è·¨æ¡†æ¶çš„DOMæ“ä½œ
- ç”ŸæˆPDFæ–‡ä»¶

### 8. lib/logRunSummary.js - è¿è¡Œæ€»ç»“

ç”Ÿæˆè¿è¡Œç»“æœçš„æ€»ç»“æŠ¥å‘Šï¼š

```javascript
const logger = require('./logger');

/**
 * è®°å½•è¿è¡Œæ€»ç»“
 * @param {Object} result - è¿è¡Œç»“æœ
 */
function logRunSummary(result) {
  const { total, success, failed, duration, results } = result;
  
  logger.info('=== è¿è¡Œæ€»ç»“ ===');
  logger.info(`æ€»ä»»åŠ¡æ•°: ${total}`);
  logger.info(`æˆåŠŸ: ${success}`);
  logger.info(`å¤±è´¥: ${failed}`);
  logger.info(`æˆåŠŸç‡: ${((success / total) * 100).toFixed(2)}%`);
  logger.info(`æ€»è€—æ—¶: ${(duration / 1000).toFixed(2)} ç§’`);
  
  if (failed > 0) {
    logger.warn('å¤±è´¥çš„ä»»åŠ¡:');
    results.filter(r => !r.success).forEach(r => {
      logger.warn(`  ${r.index}. ${r.url} - ${r.error}`);
    });
  }
  
  logger.info('=== æ€»ç»“ç»“æŸ ===');
}

module.exports = { logRunSummary };
```

**åŠŸèƒ½è¯´æ˜ï¼š**
- ç”Ÿæˆè¿è¡Œç»“æœç»Ÿè®¡
- è®¡ç®—æˆåŠŸç‡å’Œè€—æ—¶
- è®°å½•å¤±è´¥ä»»åŠ¡è¯¦æƒ…


## ğŸ“Š libç›®å½•æ¶æ„æ€»ç»“

libç›®å½•çš„ä»£ç æ¶æ„éµå¾ªä»¥ä¸‹è®¾è®¡åŸåˆ™ï¼š

### ğŸ—ï¸ æ¶æ„è®¾è®¡åŸåˆ™

1. **æ¨¡å—åŒ–è®¾è®¡**: æ¯ä¸ªæ–‡ä»¶è´Ÿè´£ç‰¹å®šåŠŸèƒ½
2. **è·¨å¹³å°å…¼å®¹**: æ”¯æŒWindowsã€macOSã€Linux
3. **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯æ•è·å’Œå¤„ç†æœºåˆ¶
4. **æ—¥å¿—è®°å½•**: ç»Ÿä¸€çš„æ—¥å¿—ç³»ç»Ÿ
5. **é…ç½®ç®¡ç†**: çµæ´»çš„é…ç½®é€‰é¡¹
6. **èµ„æºç®¡ç†**: è‡ªåŠ¨æ¸…ç†æµè§ˆå™¨èµ„æº

### ğŸ“ æ–‡ä»¶ä¾èµ–å…³ç³»

```
lib/index.js (å…¥å£)
    â†“
lib/batchProcessor.js (æ ¸å¿ƒåè°ƒ)
    â†“
lib/iframeProcessor.js (iframeå¤„ç†)
    â†“
lib/pdfGenerator.js (PDFç”Ÿæˆ)
    â†“
lib/browserConfig.js (æµè§ˆå™¨é…ç½®)
    â†“
lib/request.js (HTTPè¯·æ±‚)
    â†“
lib/logger.js (æ—¥å¿—ç³»ç»Ÿ)
```

### ğŸ”„ æ‰§è¡Œæµç¨‹

1. **å…¥å£**: `lib/index.js` ä½œä¸ºAPIå…¥å£ç‚¹
2. **åè°ƒ**: `lib/batchProcessor.js` åè°ƒæ•´ä¸ªæµç¨‹
3. **æ•°æ®è·å–**: `lib/request.js` è·å–è¯•å·åˆ—è¡¨
4. **é¡µé¢å¤„ç†**: `lib/iframeProcessor.js` å¤„ç†å¤æ‚é¡µé¢
5. **PDFç”Ÿæˆ**: `lib/pdfGenerator.js` ç”ŸæˆPDFæ–‡ä»¶
6. **æµè§ˆå™¨ç®¡ç†**: `lib/browserConfig.js` ç®¡ç†æµè§ˆå™¨é…ç½®
7. **æ—¥å¿—è®°å½•**: `lib/logger.js` è®°å½•æ‰€æœ‰æ“ä½œ
8. **ç»“æœæ€»ç»“**: `lib/logRunSummary.js` ç”Ÿæˆè¿è¡ŒæŠ¥å‘Š

### ğŸ¯ æ ¸å¿ƒç‰¹æ€§

- **è·¨å¹³å°æ”¯æŒ**: è‡ªåŠ¨æ£€æµ‹Chromeè·¯å¾„
- **é”™è¯¯æ¢å¤**: å•ä¸ªä»»åŠ¡å¤±è´¥ä¸å½±å“æ•´ä½“æµç¨‹
- **èµ„æºç®¡ç†**: è‡ªåŠ¨æ¸…ç†æµè§ˆå™¨å®ä¾‹
- **è¯¦ç»†æ—¥å¿—**: å®Œæ•´çš„æ“ä½œè®°å½•
- **çµæ´»é…ç½®**: æ”¯æŒå¤šç§å‚æ•°é…ç½®
- **æ‰¹é‡å¤„ç†**: é«˜æ•ˆçš„å¹¶å‘å¤„ç†æœºåˆ¶

è¿™ä¸ªæ¶æ„ç¡®ä¿äº†ä»£ç çš„å¯ç»´æŠ¤æ€§ã€å¯æ‰©å±•æ€§å’Œè·¨å¹³å°å…¼å®¹æ€§ï¼Œä¸ºç”¨æˆ·æä¾›äº†ç¨³å®šå¯é çš„PDFæ‰¹é‡ä¸‹è½½æœåŠ¡ã€‚








